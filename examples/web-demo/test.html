<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bresenham Lighting Engine - Debug Test</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background: #2a2a2a;
            color: #fff;
        }
        .test-container {
            margin: 20px 0;
            padding: 20px;
            border: 1px solid #555;
            border-radius: 8px;
            background: #333;
        }
        .success { border-color: #0a84ff; background: #1a3a5f; }
        .error { border-color: #ff453a; background: #5f1a1a; }
        .warning { border-color: #ff9f0a; background: #5f3a1a; }
        canvas {
            border: 1px solid #666;
            margin: 10px 0;
        }
        button {
            padding: 10px 20px;
            margin: 5px;
            border: none;
            border-radius: 4px;
            background: #0a84ff;
            color: white;
            cursor: pointer;
        }
        button:hover { background: #0056b3; }
        button:disabled { background: #666; cursor: not-allowed; }
        pre {
            background: #1a1a1a;
            padding: 10px;
            border-radius: 4px;
            overflow-x: auto;
            max-height: 200px;
            overflow-y: auto;
        }
    </style>
</head>
<body>
    <h1>üöÄ Bresenham Lighting Engine - Debug Test</h1>
    <p>This page tests the WASM module functionality step by step.</p>

    <div id="test-init" class="test-container">
        <h3>1. WASM Module Initialization</h3>
        <p>Status: <span id="init-status">‚è≥ Loading...</span></p>
        <pre id="init-details"></pre>
    </div>

    <div id="test-collision" class="test-container">
        <h3>2. Collision System Test</h3>
        <p>Status: <span id="collision-status">‚è≥ Waiting for init...</span></p>
        <button id="test-collision-btn" disabled>Test Collision Detection</button>
        <pre id="collision-details"></pre>
    </div>

    <div id="test-lighting" class="test-container">
        <h3>3. Lighting System Test</h3>
        <p>Status: <span id="lighting-status">‚è≥ Waiting for collision...</span></p>
        <button id="test-lighting-btn" disabled>Test Light Update</button>
        <pre id="lighting-details"></pre>
    </div>

    <div id="test-visual" class="test-container">
        <h3>4. Visual Test</h3>
        <p>Status: <span id="visual-status">‚è≥ Waiting for lighting...</span></p>
        <canvas id="test-canvas" width="180" height="180"></canvas>
        <br>
        <button id="test-visual-btn" disabled>Render Light</button>
        <button id="add-obstacles-btn" disabled>Add Test Obstacles</button>
        <button id="clear-obstacles-btn" disabled>Clear Obstacles</button>
        <pre id="visual-details"></pre>
    </div>

    <script type="module">
        // Set up logging function before importing WASM
        globalThis.log_from_js = function (message) {
            console.log("[WASM]", message);
        };

        globalThis.console.log_from_js = globalThis.log_from_js;
        
        import init, {
            put,
            set_collision_mode,
            get_collision_mode,
            set_pixel,
            clear_pixel_collisions,
        } from "./pkg/bresenham_lighting_engine.js";

        let wasmModule = null;
        const canvas = document.getElementById('test-canvas');
        const ctx = canvas.getContext('2d');

        function updateStatus(testId, status, className = '', details = '') {
            const statusEl = document.getElementById(`${testId}-status`);
            const containerEl = document.getElementById(`test-${testId}`);
            const detailsEl = document.getElementById(`${testId}-details`);
            
            statusEl.textContent = status;
            if (className) {
                containerEl.className = `test-container ${className}`;
            }
            if (details) {
                detailsEl.textContent = details;
            }
        }

        function log(testId, message) {
            const detailsEl = document.getElementById(`${testId}-details`);
            detailsEl.textContent += message + '\n';
        }

        // Test 1: WASM Initialization
        async function testInit() {
            try {
                updateStatus('init', '‚è≥ Loading WASM module...');
                
                const startTime = performance.now();
                wasmModule = await init();
                const endTime = performance.now();
                
                log('init', `‚úÖ WASM module loaded in ${(endTime - startTime).toFixed(2)}ms`);
                log('init', `Memory buffer size: ${wasmModule.memory.buffer.byteLength} bytes`);
                
                updateStatus('init', '‚úÖ Initialization successful', 'success');
                
                // Enable next test
                document.getElementById('test-collision-btn').disabled = false;
                updateStatus('collision', '‚ö° Ready to test');
                
            } catch (error) {
                log('init', `‚ùå Error: ${error.message}`);
                log('init', `Stack trace: ${error.stack}`);
                updateStatus('init', '‚ùå Initialization failed', 'error');
            }
        }

        // Test 2: Collision System
        async function testCollision() {
            try {
                updateStatus('collision', '‚è≥ Testing collision system...');
                
                // Test mode switching
                const initialMode = get_collision_mode();
                log('collision', `Initial collision mode: ${initialMode}`);
                
                set_collision_mode(1); // Pixel mode
                const pixelMode = get_collision_mode();
                log('collision', `Switched to pixel mode: ${pixelMode}`);
                
                if (pixelMode !== 1) {
                    throw new Error(`Expected pixel mode (1), got ${pixelMode}`);
                }
                
                // Test pixel setting
                set_pixel(50, 50, 1); // Add obstacle
                log('collision', '‚úÖ Set pixel obstacle at (50, 50)');
                
                // Test clearing
                clear_pixel_collisions();
                log('collision', '‚úÖ Cleared pixel collisions');
                
                updateStatus('collision', '‚úÖ Collision system working', 'success');
                
                // Enable next test
                document.getElementById('test-lighting-btn').disabled = false;
                updateStatus('lighting', '‚ö° Ready to test');
                
            } catch (error) {
                log('collision', `‚ùå Error: ${error.message}`);
                updateStatus('collision', '‚ùå Collision test failed', 'error');
            }
        }

        // Test 3: Lighting System
        async function testLighting() {
            try {
                updateStatus('lighting', '‚è≥ Testing lighting system...');
                
                const startTime = performance.now();
                const canvasPtr = put(0, 30, 90, 90);
                const endTime = performance.now();
                
                log('lighting', `Light update time: ${(endTime - startTime).toFixed(3)}ms`);
                log('lighting', `Canvas pointer: ${canvasPtr}`);
                
                if (canvasPtr === 0) {
                    throw new Error('Light update returned null pointer');
                }
                
                updateStatus('lighting', '‚úÖ Lighting system working', 'success');
                
                // Enable visual test
                document.getElementById('test-visual-btn').disabled = false;
                document.getElementById('add-obstacles-btn').disabled = false;
                document.getElementById('clear-obstacles-btn').disabled = false;
                updateStatus('visual', '‚ö° Ready for visual test');
                
            } catch (error) {
                log('lighting', `‚ùå Error: ${error.message}`);
                log('lighting', `Stack trace: ${error.stack}`);
                updateStatus('lighting', '‚ùå Lighting test failed', 'error');
            }
        }

        // Test 4: Visual Rendering
        async function testVisual() {
            try {
                updateStatus('visual', '‚è≥ Rendering light...');
                
                const radius = 40;
                const x = 90;
                const y = 90;
                
                const startTime = performance.now();
                const canvasPtr = put(0, radius, x, y);
                const endTime = performance.now();
                
                if (canvasPtr === 0) {
                    throw new Error('Light update returned null pointer');
                }
                
                // Clear canvas
                ctx.fillStyle = 'black';
                ctx.fillRect(0, 0, 180, 180);
                
                // Get light data
                const lightSize = radius * 2 + 1;
                const lightData = new Uint8ClampedArray(
                    wasmModule.memory.buffer,
                    canvasPtr,
                    lightSize * lightSize * 4
                );
                
                // Render light
                const imageData = new ImageData(lightData, lightSize, lightSize);
                ctx.putImageData(
                    imageData,
                    x - Math.floor(lightSize / 2),
                    y - Math.floor(lightSize / 2)
                );
                
                log('visual', `‚úÖ Light rendered in ${(endTime - startTime).toFixed(3)}ms`);
                log('visual', `Light size: ${lightSize}x${lightSize} pixels`);
                updateStatus('visual', '‚úÖ Visual rendering successful', 'success');
                
            } catch (error) {
                log('visual', `‚ùå Error: ${error.message}`);
                updateStatus('visual', '‚ùå Visual test failed', 'error');
            }
        }

        async function addTestObstacles() {
            try {
                log('visual', 'Adding test obstacles...');
                
                // Add some obstacles
                for (let x = 60; x < 120; x += 2) {
                    set_pixel(x, 70, 1);
                    set_pixel(x, 110, 1);
                }
                for (let y = 70; y < 110; y += 2) {
                    set_pixel(60, y, 1);
                    set_pixel(120, y, 1);
                }
                
                // Re-render light
                testVisual();
                
            } catch (error) {
                log('visual', `‚ùå Error adding obstacles: ${error.message}`);
            }
        }

        async function clearObstacles() {
            try {
                log('visual', 'Clearing obstacles...');
                clear_pixel_collisions();
                testVisual();
            } catch (error) {
                log('visual', `‚ùå Error clearing obstacles: ${error.message}`);
            }
        }

        // Event listeners
        document.getElementById('test-collision-btn').addEventListener('click', testCollision);
        document.getElementById('test-lighting-btn').addEventListener('click', testLighting);
        document.getElementById('test-visual-btn').addEventListener('click', testVisual);
        document.getElementById('add-obstacles-btn').addEventListener('click', addTestObstacles);
        document.getElementById('clear-obstacles-btn').addEventListener('click', clearObstacles);

        // Start testing
        testInit();
    </script>
</body>
</html> 